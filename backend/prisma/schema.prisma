generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String               @id @default(uuid())
  email               String               @unique
  password            String
  name                String
  role                UserRole
  isActive            Boolean              @default(true)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  electricityBills    ElectricityBill[]
  electricitySettings ElectricitySettings?
  invoices            Invoice[]
  maintenanceTickets  MaintenanceTicket[]
  passwordResets      PasswordReset[]
  properties          Property[]
  refreshTokens       RefreshToken[]
  ownedTenants        TenantProfile[]      @relation("OwnerToTenants")
  tenantProfile       TenantProfile?       @relation("UserToTenant")

  @@index([email])
  @@index([role])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model PasswordReset {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Property {
  id                 String              @id @default(uuid())
  ownerId            String
  name               String
  address            String?
  city               String?
  state              String?
  pincode            String?
  totalRooms         Int
  totalBeds          Int
  amenities          Json?
  active             Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  maintenanceTickets MaintenanceTicket[]
  owner              User                @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  rooms              Room[]
  tenants            TenantProfile[]

  @@index([ownerId])
  @@index([city])
  @@index([active])
}

model Room {
  id          String          @id @default(uuid())
  propertyId  String
  name        String
  roomNumber  String
  floor       Int
  capacity    Int
  occupied    Int             @default(0)
  rentPerBed  Decimal         @db.Decimal(10, 2)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  sharingType String          @default("double")
  beds        Bed[]
  property    Property        @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  tenants     TenantProfile[]

  @@unique([propertyId, roomNumber])
  @@index([propertyId])
}

model Bed {
  id        String         @id @default(uuid())
  roomId    String
  name      String
  bedNumber String
  occupied  Boolean        @default(false)
  tenantId  String?        @unique
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  room      Room           @relation(fields: [roomId], references: [id], onDelete: Cascade)
  tenant    TenantProfile? @relation(fields: [tenantId], references: [id])

  @@unique([roomId, bedNumber])
  @@index([roomId])
  @@index([occupied])
}

model TenantProfile {
  id                 String              @id @default(uuid())
  userId             String              @unique
  ownerId            String
  name               String
  email              String              @unique
  phone              String
  kycId              String?
  kycDocument        String?
  propertyId         String?
  roomId             String?
  bedId              String?
  status             TenantStatus        @default(ACTIVE)
  moveInDate         DateTime?
  moveOutDate        DateTime?
  securityDeposit    Decimal             @db.Decimal(10, 2)
  monthlyRent        Decimal             @db.Decimal(10, 2)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  bed                Bed?
  electricityBills   ElectricityBill[]
  invoices           Invoice[]
  maintenanceTickets MaintenanceTicket[]
  payments           Payment[]
  owner              User                @relation("OwnerToTenants", fields: [ownerId], references: [id])
  property           Property?           @relation(fields: [propertyId], references: [id])
  room               Room?               @relation(fields: [roomId], references: [id])
  user               User                @relation("UserToTenant", fields: [userId], references: [id], onDelete: Cascade)

  @@index([ownerId])
  @@index([userId])
  @@index([email])
  @@index([status])
  @@index([propertyId])
}

model ElectricitySettings {
  id                String       @id @default(uuid())
  ownerId           String       @unique
  ratePerUnit       Decimal      @db.Decimal(10, 2)
  dueDate           Int
  isEnabled         Boolean      @default(true)
  lateFeePercentage Decimal      @default(0) @db.Decimal(5, 2)
  minimumUnits      Decimal      @default(0) @db.Decimal(10, 2)
  maximumUnits      Decimal      @default(1000) @db.Decimal(10, 2)
  billingCycle      BillingCycle @default(MONTHLY)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  owner             User         @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([ownerId])
}

model ElectricityBill {
  id              String        @id @default(uuid())
  ownerId         String
  tenantId        String
  month           String
  previousReading Decimal       @db.Decimal(10, 2)
  currentReading  Decimal       @db.Decimal(10, 2)
  units           Decimal       @db.Decimal(10, 2)
  ratePerUnit     Decimal       @db.Decimal(10, 2)
  amount          Decimal       @db.Decimal(10, 2)
  status          BillStatus    @default(PENDING)
  imageUrl        String?
  notes           String?
  submittedAt     DateTime      @default(now())
  approvedAt      DateTime?
  rejectedAt      DateTime?
  paidAt          DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  owner           User          @relation(fields: [ownerId], references: [id])
  tenant          TenantProfile @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, month])
  @@index([ownerId])
  @@index([tenantId])
  @@index([status])
  @@index([month])
}

model Invoice {
  id                 String        @id @default(uuid())
  ownerId            String
  tenantId           String
  month              String
  amount             Decimal       @db.Decimal(10, 2)
  baseRent           Decimal       @db.Decimal(10, 2)
  electricityCharges Decimal       @default(0) @db.Decimal(10, 2)
  otherCharges       Decimal       @default(0) @db.Decimal(10, 2)
  lateFees           Decimal       @default(0) @db.Decimal(10, 2)
  status             InvoiceStatus @default(DUE)
  dueDate            DateTime
  paidAt             DateTime?
  receiptNo          String?       @unique
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  owner              User          @relation(fields: [ownerId], references: [id])
  tenant             TenantProfile @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  payments           Payment[]

  @@unique([tenantId, month])
  @@index([ownerId])
  @@index([tenantId])
  @@index([status])
  @@index([month])
  @@index([dueDate])
}

model Payment {
  id               String        @id @default(uuid())
  invoiceId        String
  tenantId         String
  amount           Decimal       @db.Decimal(10, 2)
  method           PaymentMethod
  status           PaymentStatus @default(PENDING)
  transactionId    String?       @unique
  upiTransactionId String?
  notes            String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  invoice          Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  tenant           TenantProfile @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([tenantId])
  @@index([status])
  @@index([transactionId])
}

model MaintenanceTicket {
  id          String         @id @default(uuid())
  ownerId     String
  tenantId    String
  propertyId  String
  title       String
  description String?
  status      TicketStatus   @default(OPEN)
  priority    TicketPriority @default(MEDIUM)
  category    TicketCategory
  assignedTo  String?
  images      Json?
  resolvedAt  DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  owner       User           @relation(fields: [ownerId], references: [id])
  property    Property       @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  tenant      TenantProfile  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([ownerId])
  @@index([tenantId])
  @@index([propertyId])
  @@index([status])
  @@index([priority])
}

enum UserRole {
  OWNER
  TENANT
}

enum TenantStatus {
  ACTIVE
  INACTIVE
}

enum BillStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}

enum InvoiceStatus {
  DUE
  PAID
  PARTIAL
  OVERDUE
}

enum PaymentMethod {
  UPI
  CARD
  NETBANKING
  WALLET
  CASH
}

enum PaymentStatus {
  SUCCESS
  FAILED
  PENDING
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketCategory {
  PLUMBING
  ELECTRICAL
  CLEANING
  WIFI
  AC
  OTHER
}

enum BillingCycle {
  MONTHLY
  BI_MONTHLY
  QUARTERLY
}
