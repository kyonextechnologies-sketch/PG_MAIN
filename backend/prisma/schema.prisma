generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String               @id @default(uuid())
  email               String               @unique
  password            String
  name                String
  role                UserRole
  isActive            Boolean              @default(true)
  phone               String?              @unique
  phoneVerified       Boolean              @default(false)
  phoneVerifiedAt     DateTime?
  emailVerified       Boolean              @default(false)
  emailVerifiedAt     DateTime?
  emailVerificationToken String?           @unique
  emailVerificationTokenExpiry DateTime?
  fcmToken            String?
  company             String?
  // Payment settings
  upiId               String?
  upiName             String?
  autoGenerateInvoices Boolean             @default(true)
  invoiceReminderDays  Int                 @default(3)
  lateFeePercentage    Decimal             @default(2) @db.Decimal(5, 2)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  electricityBills    ElectricityBill[]
  electricitySettings ElectricitySettings?
  invoices            Invoice[]
  maintenanceTickets  MaintenanceTicket[]
  passwordResets      PasswordReset[]
  properties          Property[]
  refreshTokens       RefreshToken[]
  ownedTenants        TenantProfile[]      @relation("OwnerToTenants")
  tenantProfile       TenantProfile?       @relation("UserToTenant")
  ownerVerification   OwnerVerification?
  subscription        Subscription?
  ownerSubscriptions  OwnerSubscription[]
  notifications       Notification[]
  auditLogs           AuditLog[]
  otps                OTP[]

  @@index([email])
  @@index([role])
  @@index([phone])
  @@index([emailVerified])
  @@index([emailVerificationToken])
  @@index([isActive, role])
  @@index([createdAt])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model PasswordReset {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Property {
  id                 String              @id @default(uuid())
  ownerId            String
  name               String
  address            String?
  city               String?
  state              String?
  pincode            String?
  totalRooms         Int
  totalBeds          Int
  amenities          Json?
  active             Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  maintenanceTickets MaintenanceTicket[]
  owner              User                @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  rooms              Room[]
  tenants            TenantProfile[]

  @@unique([ownerId, name], name: "ownerId_name_unique")
  @@index([ownerId])
  @@index([city])
  @@index([active])
  @@index([ownerId, active])
  @@index([createdAt])
}

model Room {
  id          String          @id @default(uuid())
  propertyId  String
  name        String
  roomNumber  String
  floor       Int
  capacity    Int
  occupied    Int             @default(0)
  rentPerBed  Decimal         @db.Decimal(10, 2)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  sharingType String          @default("double")
  beds        Bed[]
  property    Property        @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  tenants     TenantProfile[]

  @@unique([propertyId, roomNumber])
  @@index([propertyId])
}

model Bed {
  id        String         @id @default(uuid())
  roomId    String
  name      String
  bedNumber String
  occupied  Boolean        @default(false)
  tenantId  String?        @unique
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  room      Room           @relation(fields: [roomId], references: [id], onDelete: Cascade)
  tenant    TenantProfile? @relation(fields: [tenantId], references: [id])

  @@unique([roomId, bedNumber])
  @@index([roomId])
  @@index([occupied])
}

model TenantProfile {
  id                 String              @id @default(uuid())
  userId             String              @unique
  ownerId            String
  name               String
  email              String              @unique
  phone              String
  kycId              String?
  kycDocument        String?
  propertyId         String?
  roomId             String?
  bedId              String?
  status             TenantStatus        @default(ACTIVE)
  moveInDate         DateTime?
  moveOutDate        DateTime?
  securityDeposit    Decimal             @db.Decimal(10, 2)
  monthlyRent        Decimal             @db.Decimal(10, 2)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  bed                Bed?
  electricityBills   ElectricityBill[]
  invoices           Invoice[]
  maintenanceTickets MaintenanceTicket[]
  payments           Payment[]
  owner              User                @relation("OwnerToTenants", fields: [ownerId], references: [id])
  property           Property?           @relation(fields: [propertyId], references: [id])
  room               Room?               @relation(fields: [roomId], references: [id])
  user               User                @relation("UserToTenant", fields: [userId], references: [id], onDelete: Cascade)

  @@index([ownerId])
  @@index([userId])
  @@index([email])
  @@index([status])
  @@index([propertyId])
  @@index([ownerId, status])
  @@index([propertyId, status])
  @@index([createdAt])
}

model ElectricitySettings {
  id                String       @id @default(uuid())
  ownerId           String       @unique
  ratePerUnit       Decimal      @db.Decimal(10, 2)
  dueDate           Int
  isEnabled         Boolean      @default(true)
  lateFeePercentage Decimal      @default(0) @db.Decimal(5, 2)
  minimumUnits      Decimal      @default(0) @db.Decimal(10, 2)
  maximumUnits      Decimal      @default(1000) @db.Decimal(10, 2)
  billingCycle      BillingCycle @default(MONTHLY)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  owner             User         @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([ownerId])
}

model ElectricityBill {
  id              String        @id @default(uuid())
  ownerId         String
  tenantId        String
  month           String
  previousReading Decimal       @db.Decimal(10, 2)
  currentReading  Decimal       @db.Decimal(10, 2)
  units           Decimal       @db.Decimal(10, 2)
  ratePerUnit     Decimal       @db.Decimal(10, 2)
  amount          Decimal       @db.Decimal(10, 2)
  status          BillStatus    @default(PENDING)
  imageUrl        String?
  notes           String?
  submittedAt     DateTime      @default(now())
  approvedAt      DateTime?
  rejectedAt      DateTime?
  paidAt          DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  owner           User          @relation(fields: [ownerId], references: [id])
  tenant          TenantProfile @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, month])
  @@index([ownerId])
  @@index([tenantId])
  @@index([status])
  @@index([month])
}

model Invoice {
  id                 String        @id @default(uuid())
  ownerId            String
  tenantId           String
  month              String
  amount             Decimal       @db.Decimal(10, 2)
  baseRent           Decimal       @db.Decimal(10, 2)
  electricityCharges Decimal       @default(0) @db.Decimal(10, 2)
  otherCharges       Decimal       @default(0) @db.Decimal(10, 2)
  lateFees           Decimal       @default(0) @db.Decimal(10, 2)
  status             InvoiceStatus @default(DUE)
  dueDate            DateTime
  paidAt             DateTime?
  receiptNo          String?       @unique
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  owner              User          @relation(fields: [ownerId], references: [id])
  tenant             TenantProfile @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  payments           Payment[]

  @@unique([tenantId, month])
  @@index([ownerId])
  @@index([tenantId])
  @@index([status])
  @@index([month])
  @@index([dueDate])
  @@index([ownerId, status])
  @@index([tenantId, status])
  @@index([dueDate, status])
  @@index([createdAt])
}

model Payment {
  id               String        @id @default(uuid())
  invoiceId        String
  tenantId         String
  amount           Decimal       @db.Decimal(10, 2)
  method           PaymentMethod
  status           PaymentStatus @default(PENDING)
  transactionId    String?       @unique
  upiTransactionId String?
  notes            String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  invoice          Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  tenant           TenantProfile @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([tenantId])
  @@index([status])
  @@index([transactionId])
}

model MaintenanceTicket {
  id             String         @id @default(uuid())
  ownerId        String
  tenantId       String
  propertyId     String
  title          String
  description    String?
  status         TicketStatus   @default(OPEN)
  priority       TicketPriority @default(MEDIUM)
  category       TicketCategory
  assignedTo     String?
  images         Json?
  timeline       Json?
  gotItByOwner   Boolean        @default(false)
  gotItAt        DateTime?
  lastReminderAt DateTime?
  reminderJobId  String?
  resolvedAt     DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  owner          User           @relation(fields: [ownerId], references: [id])
  property       Property       @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  tenant         TenantProfile  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([ownerId])
  @@index([tenantId])
  @@index([propertyId])
  @@index([status])
  @@index([priority])
  @@index([ownerId, status])
  @@index([tenantId, status])
  @@index([createdAt])
}

enum UserRole {
  OWNER
  TENANT
  ADMIN
}

enum TenantStatus {
  ACTIVE
  INACTIVE
}

enum BillStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}

enum InvoiceStatus {
  DUE
  PAID
  PARTIAL
  OVERDUE
}

enum PaymentMethod {
  UPI
  CARD
  NETBANKING
  WALLET
  CASH
}

enum PaymentStatus {
  SUCCESS
  FAILED
  PENDING
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketCategory {
  PLUMBING
  ELECTRICAL
  CLEANING
  WIFI
  AC
  OTHER
}

enum BillingCycle {
  MONTHLY
  BI_MONTHLY
  QUARTERLY
}

enum SubscriptionBillingPeriod {
  MONTH
  QUARTER
}

model OTP {
  id                 String   @id @default(uuid())
  userId             String?
  phone              String
  otpHash            String
  attempts           Int      @default(0)
  expiresAt          DateTime
  createdAt          DateTime @default(now())
  verificationToken  String?  // Token issued after successful verification
  tokenExpiresAt     DateTime? // Verification token expiry
  verified           Boolean  @default(false) // Whether OTP was verified
  user               User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([phone])
  @@index([expiresAt])
  @@index([verificationToken])
}

model Notification {
  id          String              @id @default(uuid())
  userId      String
  type        NotificationType
  title       String
  message     String
  data        Json?
  channels    NotificationChannel[]
  isRead      Boolean             @default(false)
  readAt      DateTime?
  sentAt      DateTime?
  failedAt    DateTime?
  error       String?
  createdAt   DateTime            @default(now())
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([isRead])
  @@index([createdAt])
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?
  action     String
  resource   String
  resourceId String?
  details    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
}

model OwnerVerification {
  id                   String             @id @default(uuid())
  ownerId              String             @unique
  verificationStatus   VerificationStatus @default(PENDING)
  legalDocuments       Json?              // Legacy field - kept for backward compatibility
  rejectionReason      String?
  verifiedAt           DateTime?
  verifiedBy           String?
  submittedAt          DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  // Separate document fields for better tracking
  aadhaarFront         String?            // File path/URL for Aadhaar front
  aadhaarBack          String?            // File path/URL for Aadhaar back
  pan                  String?            // File path/URL for PAN card
  gst                  String?            // File path/URL for GST certificate (optional)
  addressProof         String?            // File path/URL for address proof
  ownerPhoto           String?            // File path/URL for owner photo
  // Document verification status per type
  aadhaarFrontStatus   DocumentStatus     @default(PENDING)
  aadhaarBackStatus    DocumentStatus     @default(PENDING)
  panStatus            DocumentStatus     @default(PENDING)
  gstStatus            DocumentStatus     @default(PENDING)
  addressProofStatus   DocumentStatus     @default(PENDING)
  ownerPhotoStatus     DocumentStatus     @default(PENDING)
  // Rejection reasons per document
  aadhaarFrontRejectionReason String?
  aadhaarBackRejectionReason  String?
  panRejectionReason          String?
  gstRejectionReason          String?
  addressProofRejectionReason String?
  ownerPhotoRejectionReason   String?
  owner                User               @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([verificationStatus])
  @@index([ownerId])
}

enum DocumentStatus {
  PENDING
  APPROVED
  REJECTED
}

model Subscription {
  id                String            @id @default(uuid())
  ownerId           String            @unique
  packageName       SubscriptionPackage
  status            SubscriptionStatus @default(ACTIVE)
  startDate         DateTime          @default(now())
  endDate           DateTime?
  price             Decimal           @db.Decimal(10, 2)
  billingCycle      BillingCycle      @default(MONTHLY)
  autoRenew         Boolean           @default(true)
  cancelledAt       DateTime?
  cancelledBy       String?
  cancellationReason String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  owner             User              @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([ownerId])
  @@index([status])
  @@index([packageName])
}

model SubscriptionPlan {
  id                 String                     @id @default(uuid())
  code               String                     @unique
  name               String
  billingPeriod      SubscriptionBillingPeriod
  priceInPaise       Int
  maxProperties      Int?
  maxTenants         Int?
  basicReports       Boolean                    @default(false)
  advancedReports    Boolean                    @default(false)
  advancedAnalytics  Boolean                    @default(false)
  autoBilling        Boolean                    @default(false)
  prioritySupport    Boolean                    @default(false)
  priority24x7       Boolean                    @default(false)
  customIntegrations Boolean                    @default(false)
  createdAt          DateTime                   @default(now())
  updatedAt          DateTime                   @updatedAt
  ownerSubscriptions OwnerSubscription[]

  @@index([code])
}

model OwnerSubscription {
  id                String               @id @default(uuid())
  ownerId           String
  planId            String
  planCode          String
  status            SubscriptionStatus   @default(ACTIVE)
  startDate         DateTime             @default(now())
  endDate           DateTime?
  autoRenew         Boolean              @default(true)
  cancelAtPeriodEnd Boolean              @default(false)
  cancelledAt       DateTime?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  owner             User                 @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  plan              SubscriptionPlan     @relation(fields: [planId], references: [id], onDelete: Restrict)
  payments          SubscriptionPayment[]

  @@index([ownerId])
  @@index([planCode])
  @@index([status])
}

model SubscriptionPayment {
  id                  String             @id @default(uuid())
  ownerSubscriptionId String
  amountInPaise       Int
  currency            String             @default("INR")
  provider            String?
  orderId             String?
  paymentId           String?
  status              PaymentStatus      @default(PENDING)
  rawPayload          Json?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  ownerSubscription   OwnerSubscription  @relation(fields: [ownerSubscriptionId], references: [id], onDelete: Cascade)

  @@index([ownerSubscriptionId])
  @@index([orderId])
  @@index([paymentId])
}

enum NotificationType {
  MAINTENANCE_REQUEST
  MAINTENANCE_UPDATE
  OWNER_ACKNOWLEDGED
  PAYMENT_DUE
  PAYMENT_RECEIVED
  RENT_REMINDER
  SYSTEM
}

enum NotificationChannel {
  EMAIL
  SMS
  PUSH
  IN_APP
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum SubscriptionPackage {
  BASIC
  STANDARD
  PREMIUM
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  SUSPENDED
}
